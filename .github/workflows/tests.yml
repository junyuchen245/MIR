name: Run Tests

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "pyproject.toml"
      - "requirements.txt"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "pyproject.toml"
      - "requirements.txt"
  workflow_dispatch:

jobs:
  pytest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.8.16"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          pip install antspyx
          pip install SimpleITK --only-binary=:all:
          pip install torch==2.0.1 --index-url https://download.pytorch.org/whl/cpu
          pip install torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
          pip install \
            einops==0.8.1 \
            matplotlib==3.7.3 \
            ml_collections==0.1.1 \
            nibabel==5.2.1 \
            numpy==1.24.4 \
            pymedio==0.2.5 \
            scipy==1.10.1 \
            seaborn==0.11.0 \
            statsmodels==0.14.0 \
            natsort
          pip install timm==0.9.10 --no-deps
          pip install -e . --no-deps

      - name: Run tests
        run: pytest -q tests
